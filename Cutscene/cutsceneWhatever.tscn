[gd_scene load_steps=5 format=2]

[ext_resource path="res://Cutscene/CutsceneMain.tscn" type="PackedScene" id=1]
[ext_resource path="res://Cutscene/Backgrounds/2021summer_SANGVISFERRI.png" type="Texture" id=2]
[ext_resource path="res://stepmania-compat/smSprite.gd" type="Script" id=3]

[sub_resource type="GDScript" id=1]
script/source = "extends Node2D

export (String) var custom_music_name
export (String) var nsf_music_file
export (int) var nsf_track_num = 0
onready var music_player = Globals.ReinaAudioPlayer.new(self)

func getStuff(time:float)->String:
	if time== 0.0 or CheckpointPlayerStats.usedDebugMode:
		return \"Next time, try it without debug mode!\"
	elif time < 120.0:
		return \"Wow, they don't call you Task Force 404 for nothing!\"
	elif time < 180.0:
		return \"Not bad!\"
	else:
		return \"Hmm... Looks like you're still getting the hang of the simulator.\"

#var cutsceneInformation:PoolStringArray = [
#	\"preload_portraits Dier|pic_Architect\",
#	\"portrait Dier\",
#	\"speaker AmWorks\",
#	\"msg /hl[0]Let's see... It took you [color=#ff00ff]%s[/color] to clear the stage on %s. %s\" % [ Globals.format_time(CheckpointPlayerStats.timerWithDeath), tr(Globals.difficultyToString()), getStuff(CheckpointPlayerStats.timerWithDeath)],
#	\"speaker AmWorks\",
#	\"msg Thanks for trying the demo! I hope you enjoyed it.\",
#	\"portrait Dier|pic_Architect\",
#	\"speaker Architect\",
#	\"msg /hl[1]Did you like the boss battle? It was cool, right? Right?\",
#	\"msg By the way, you've obtained my weapon! Try the stage again, then use Q/E or L1/R1 to switch weapons.\",
#	\"speaker AmWorks\",
#	\"msg /hl[0]If you'd like to leave feedback, click the button on the title screen. You can also email me random Girls' Frontline fanart, if you want.\"
#	#\"msg|SEE YOU NEXT DEMO (Hopefully)!\"
#]
var cutsceneInformation:PoolStringArray = [
	\"preload_portraits Dier|pic_Alchemist|pic_Scarecrow\",
	\"portrait Dier\",
	\"matchnames AmWorks|Alchemist|Scarecrow\",
	\"speaker AmWorks\",
	\"msg So, did you enjoy the second demo? Hopefully it was worth the wait.\",
	\"portrait Dier|pic_Alchemist\",
	\"speaker Alchemist\",
	\"msg /hl[1]We hope you enjoyed the upside-down castle. And certain boss battle moves.\",
	\"msg Surely you've played other Capcom games, right?\",
	\"speaker Scarecrow\",
	\"portrait Dier|pic_Alchemist|pic_Scarecrow\",
	\"msg /hl[2]See you soon for the next demo, featuring me.\"
]


func _ready():
	Globals.availableWeapons[1]=true
	if Globals.gameDifficulty>1 and CheckpointPlayerStats.playerLivesLeft==3:
		cutsceneInformation.append(\"msg|You're pretty good! Congratulations, you've unlocked \\\"Zero Test\\\" in the Extras.\")
		Globals.unlockedZeroMode=true
# warning-ignore:return_value_discarded
	Globals.save_system_data()
	$Sprite.Cover()
	#init_(message, parent, dim_background = true)
	$Cutscene.init_(cutsceneInformation,null,false)
	music_player.load_song(custom_music_name,nsf_music_file,nsf_track_num)
	$Cutscene.connect(\"cutscene_finished\",self,\"a\")

func a():
	# I'm going to cry
	# So the NSF player plugin for Godot will crash on release builds if you try playing more than one song at a time
	# And miraculously this is the only time I've had two consecutive screens with NSFs playing and I guess they're close enough that it's trying to play the new audio before stopping the old audio
	music_player.stop_music()
	music_player.nsf_player.queue_free()
	#music_player.nsf_player.queue_free()
	print(\"Tweening to credits...\")
	var t := TweenSequence.new(get_tree())
	t._tween.pause_mode = Node.PAUSE_MODE_PROCESS
	t.append($Sprite,'modulate:a',1,.5).set_trans(Tween.TRANS_QUAD)
	t.append_callback(self,\"toCredits\")
	yield(t,\"finished\")
	print(\"Going to credits...\")
# warning-ignore:return_value_discarded
	get_tree().change_scene(\"res://Credits.tscn\")
#unc toCredits():
	pass
	
"

[node name="Node2D" type="Node2D"]
script = SubResource( 1 )
custom_music_name = "DemoEnding"
nsf_music_file = "Rockman 4MI.nsf"
nsf_track_num = 105

[node name="Sprite" type="Sprite" parent="."]
scale = Vector2( 1.25038, 1.25015 )
texture = ExtResource( 2 )
centered = false
region_rect = Rect2( 0, 0, 1280, 720 )
script = ExtResource( 3 )

[node name="Cutscene" parent="." instance=ExtResource( 1 )]

[node name="AudioStreamPlayer" type="AudioStreamPlayer" parent="."]
bus = "Music"
